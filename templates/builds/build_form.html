{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>
            {% if form.instance.pk %}Edit{% else %}Create{% endif %} Build
          </h2>
        </div>
        
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data" id="build-form" novalidate>
            {% csrf_token %}
            
            <!-- Build Information -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-card-heading me-1"></i>Build Title
                  </label>
                  {{ form.title }}
                  {% if form.title.errors %}
                    <div class="text-danger small">{{ form.title.errors }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-tags me-1"></i>Category
                  </label>
                  {{ form.category }}
                  {% if form.category.errors %}
                    <div class="text-danger small">{{ form.category.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                <i class="bi bi-file-text me-1"></i>Description
              </label>
              {{ form.description }}
              {% if form.description.errors %}
                <div class="text-danger small">{{ form.description.errors }}</div>
              {% endif %}
            </div>
            
            <!-- Equipment Fields -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.weapons.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-sword me-1"></i>Weapons
                  </label>
                  {{ form.weapons }}
                  {% if form.weapons.errors %}
                    <div class="text-danger small">{{ form.weapons.errors }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.armor.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-shield me-1"></i>Armor
                  </label>
                  {{ form.armor }}
                  {% if form.armor.errors %}
                    <div class="text-danger small">{{ form.armor.errors }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.talismans.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-gem me-1"></i>Talismans
                  </label>
                  {{ form.talismans }}
                  {% if form.talismans.errors %}
                    <div class="text-danger small">{{ form.talismans.errors }}</div>
                  {% endif %}
                </div>
                
                <div class="mb-3">
                  <label for="{{ form.spells.id_for_label }}" class="form-label fw-bold">
                    <i class="bi bi-lightning me-1"></i>Spells <small class="text-muted">(Optional)</small>
                  </label>
                  {{ form.spells }}
                  {% if form.spells.errors %}
                    <div class="text-danger small">{{ form.spells.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Image Upload Section -->
            <div class="mb-4">
              <h5 class="fw-bold mb-3">
                <i class="bi bi-images me-2"></i>Build Images 
                <small class="text-muted">(Max 3 images, 10MB each)</small>
              </h5>
              
              <div class="image-formset">
                {{ image_formset.management_form }}
                
                <div id="image-forms">
                  {% for form in image_formset %}
                    <div class="image-upload-item">
                      <div class="row align-items-center">
                        <div class="col-md-6">
                          <label class="form-label">
                            <i class="bi bi-upload me-1"></i>Image File
                          </label>
                          {{ form.image }}
                          {% if form.image.errors %}
                            <div class="text-danger small">{{ form.image.errors }}</div>
                          {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                          <label class="form-label">Caption</label>
                          {{ form.caption }}
                          {% if form.caption.errors %}
                            <div class="text-danger small">{{ form.caption.errors }}</div>
                          {% endif %}
                        </div>
                        
                        <div class="col-md-2">
                          <div class="form-check">
                            {{ form.is_primary }}
                            <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                              Primary
                            </label>
                          </div>
                          
                          {% if form.instance.pk %}
                            <div class="form-check mt-2">
                              {{ form.DELETE }}
                              <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                Delete
                              </label>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      
                      {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
                
                <div class="file-upload-info">
                  <i class="bi bi-info-circle me-1"></i>
                  <strong>Upload Guidelines:</strong>
                  <ul class="mb-0 mt-1">
                    <li>Maximum 3 images per build</li>
                    <li>Each image must be under 10MB</li>
                    <li>Supported formats: JPG, PNG, WEBP</li>
                    <li>Mark one image as "Primary" to be the main display image</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Form Actions -->
            <div class="d-flex btn-gap">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>
                {% if form.instance.pk %}Update{% else %}Create{% endif %} Build
              </button>
              
              <a href="{% url 'build-list' %}" class="btn btn-secondary">
                <i class="bi bi-x-lg me-1"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Override the problematic JavaScript -->
<script>
// Force disable any form validation on the build form
document.addEventListener('DOMContentLoaded', function() {
    const buildForm = document.getElementById('build-form');
    if (buildForm) {
        console.log('Build form found - ensuring clean submission');
        // Remove any existing event listeners by cloning the form
        const newForm = buildForm.cloneNode(true);
        buildForm.parentNode.replaceChild(newForm, buildForm);
        console.log('Build form event listeners cleared');
    }
});
</script>
{% endblock %}
