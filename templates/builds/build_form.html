{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-3 py-md-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
      <div class="card border-0 shadow">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0 h4">
            ‚ûï {% if form.instance.pk %}Edit{% else %}Create{% endif %} Build
          </h2>
        </div>
        
        <div class="card-body p-3 p-md-4">
          <form method="POST" enctype="multipart/form-data" id="build-form" novalidate>
            {% csrf_token %}
            
            <!-- Build Information -->
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="mb-3">
                  <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                    üìù Build Title
                  </label>
                  {{ form.title }}
                  {% if form.title.errors %}
                    <div class="text-danger small">{{ form.title.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                üìÑ Description
              </label>
              {{ form.description }}
              {% if form.description.errors %}
                <div class="text-danger small">{{ form.description.errors }}</div>
              {% endif %}
            </div>
            
            <!-- Equipment Fields -->
            <div class="equipment-section">
              <h5 class="section-title mb-3">‚öîÔ∏è Equipment & Loadout</h5>
              <p class="text-muted small mb-4">Some items may not be in the API Database, Manually entering still works</p>
              
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="mb-3">
                    <label for="{{ form.weapons.id_for_label }}" class="form-label fw-bold">
                      ‚öîÔ∏è Weapons
                    </label>
                    {{ form.weapons }}
                    {% if form.weapons.errors %}
                      <div class="text-danger small">{{ form.weapons.errors }}</div>
                    {% endif %}
                  </div>
                  
                  <div class="mb-3">
                    <label for="{{ form.talismans.id_for_label }}" class="form-label fw-bold">
                      üíé Talismans
                    </label>
                    {{ form.talismans }}
                    {% if form.talismans.errors %}
                      <div class="text-danger small">{{ form.talismans.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-md-6">
                  <div class="mb-3">
                    <label for="{{ form.armor.id_for_label }}" class="form-label fw-bold">
                      üõ°Ô∏è Armor
                    </label>
                    {{ form.armor }}
                    {% if form.armor.errors %}
                      <div class="text-danger small">{{ form.armor.errors }}</div>
                    {% endif %}
                  </div>
                  
                  <div class="mb-3">
                    <label for="{{ form.spells.id_for_label }}" class="form-label fw-bold">
                      ‚ö° Spells <span class="text-muted fw-normal">(Optional)</span>
                    </label>
                    {{ form.spells }}
                    {% if form.spells.errors %}
                      <div class="text-danger small">{{ form.spells.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Player Stats Section -->
            <div class="stats-section">
              <h5 class="section-title mb-3">üìä Character Stats <span class="text-muted fw-normal">(Optional)</span></h5>
              <p class="text-muted small mb-4">Enter your character's stats to help others understand the build requirements</p>
              
              <div class="row g-3">
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.level.id_for_label }}" class="form-label fw-bold">
                      üéØ Level
                    </label>
                    {{ form.level }}
                    {% if form.level.errors %}
                      <div class="text-danger small">{{ form.level.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.vigor.id_for_label }}" class="form-label fw-bold">
                      üíñ Vigor
                    </label>
                    {{ form.vigor }}
                    {% if form.vigor.errors %}
                      <div class="text-danger small">{{ form.vigor.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.mind.id_for_label }}" class="form-label fw-bold">
                      üß† Mind
                    </label>
                    {{ form.mind }}
                    {% if form.mind.errors %}
                      <div class="text-danger small">{{ form.mind.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.endurance.id_for_label }}" class="form-label fw-bold">
                      üèÉ Endurance
                    </label>
                    {{ form.endurance }}
                    {% if form.endurance.errors %}
                      <div class="text-danger small">{{ form.endurance.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.strength.id_for_label }}" class="form-label fw-bold">
                      üí™ Strength
                    </label>
                    {{ form.strength }}
                    {% if form.strength.errors %}
                      <div class="text-danger small">{{ form.strength.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.dexterity.id_for_label }}" class="form-label fw-bold">
                      üèπ Dexterity
                    </label>
                    {{ form.dexterity }}
                    {% if form.dexterity.errors %}
                      <div class="text-danger small">{{ form.dexterity.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.intelligence.id_for_label }}" class="form-label fw-bold">
                      üìö Intelligence
                    </label>
                    {{ form.intelligence }}
                    {% if form.intelligence.errors %}
                      <div class="text-danger small">{{ form.intelligence.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.faith.id_for_label }}" class="form-label fw-bold">
                      ‚ö° Faith
                    </label>
                    {{ form.faith }}
                    {% if form.faith.errors %}
                      <div class="text-danger small">{{ form.faith.errors }}</div>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-12 col-sm-6 col-md-4">
                  <div class="mb-3">
                    <label for="{{ form.arcane.id_for_label }}" class="form-label fw-bold">
                      üîÆ Arcane
                    </label>
                    {{ form.arcane }}
                    {% if form.arcane.errors %}
                      <div class="text-danger small">{{ form.arcane.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Category Selection -->
            <div class="mb-4">
              <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                üéØ Build Category
              </label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="text-danger small">{{ form.category.errors }}</div>
              {% endif %}
            </div>
            
            <!-- Image Upload Section -->
            <div class="mb-4">
              <h5 class="fw-bold mb-3">
                üñºÔ∏è Build Images 
                <small class="text-muted">(Max 3 images, 10MB each)</small>
              </h5>
              
              <div class="image-upload-section">
                {{ image_formset.management_form }}
                
                <!-- Existing Images (for editing) -->
                <div id="existing-images" class="mb-3">
                  {% for form in image_formset %}
                    {% if form.instance.pk %}
                      <div class="existing-image mb-3 p-3 border rounded">
                        <div class="row align-items-center">
                          <div class="col-md-8">
                            <div class="image-preview">
                              <div class="preview-wrapper">
                                <img src="{{ form.instance.image.url }}" alt="Build image" 
                                     style="max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 4px;">
                                {% if form.instance.is_primary %}
                                  <span class="primary-badge">‚≠ê PRIMARY</span>
                                {% endif %}
                              </div>
                            </div>
                            {{ form.image }}
                            {{ form.is_primary }}
                            {{ form.id }}
                          </div>
                          
                          <div class="col-md-4 text-end">
                            <div class="form-check">
                              {{ form.DELETE }}
                              <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                üóëÔ∏è Delete Image
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <!-- Hidden fields for empty forms -->
                      <div style="display: none;">
                        {{ form.as_p }}
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
                
                <!-- Simple Multiple File Upload -->
                <div class="simple-upload mb-3">
                  <label for="multiple-images" class="form-label fw-bold">
                    üì∏ Choose Images (up to 3)
                  </label>
                  <input type="file" 
                         id="multiple-images" 
                         name="images-0-image" 
                         multiple 
                         accept="image/*" 
                         class="form-control"
                         max="3">
                  <small class="form-text text-muted">
                    Select up to 3 images at once. First image will be primary.
                    {% if form.instance.pk %}<strong>Note:</strong> Uploading new images will replace all existing images.{% endif %}
                  </small>
                </div>
                
                <!-- Image Previews -->
                <div id="image-previews" class="mb-3"></div>
                
                <div class="file-upload-info">
                  ‚ÑπÔ∏è <strong>Upload Guidelines:</strong>
                  <ul class="mb-0 mt-1">
                    <li>Select up to 3 images at once from your file browser</li>
                    <li>First image will automatically be marked as primary</li>
                    <li>Each image must be under 10MB</li>
                    <li>Supported formats: JPG, PNG, WEBP</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Form Actions -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                ‚úÖ {% if form.instance.pk %}Update{% else %}Create{% endif %} Build
              </button>
              
              <a href="{% url 'build-list' %}" class="btn btn-secondary">
                ‚ùå Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/elden-ring-api.js' %}"></script>
<script src="{% static 'js/image-upload.js' %}"></script>
{% endblock %}
